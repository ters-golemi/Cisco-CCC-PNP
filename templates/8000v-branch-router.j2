{# Cisco ISR 8000v Branch Router Configuration Template #}
{# PnP DHCP Server with Option 43 Configuration #}
{# Device: {{ device.name }} #}

! Cisco ISR 8000v Branch Router Configuration
! Generated: {{ timestamp }}
! Device: {{ device.name }}
! Role: {{ device.role }}

version 16.12
service timestamps debug datetime msec
service timestamps log datetime msec
no service password-encryption
service call-home
!
hostname {{ device.name }}
!
! Enable necessary services
no ip http server
ip http secure-server
ip http authentication local
!
! Configure management users
username admin privilege 15 secret 5 $1$mERr$hx5rVt7rPNoS4wqbXKX7m0
username pnp privilege 15 secret 5 $1$mERr$hx5rVt7rPNoS4wqbXKX7m0
!
! Enable SSH
ip domain-name {{ topology.catalyst_center.settings.domain }}
crypto key generate rsa general-keys modulus 2048
ip ssh version 2
line vty 0 4
 login local
 transport input ssh
!
! Configure interfaces
{% for interface in device.interfaces %}
interface {{ interface.name }}
 description {{ interface.description }}
{% if interface.ip == "dhcp" %}
 ip address dhcp
{% else %}
 ip address {{ interface.ip }}
{% endif %}
 no shutdown
{% if interface.type == "routed" %}
 no switchport
{% endif %}
!
{% endfor %}

! Configure loopback for management
interface Loopback0
 description Management Loopback
 ip address {{ device.mgmt_ip }} 255.255.255.0
!

{% if device.services.dhcp_server.enabled %}
! DHCP Configuration with PnP Option 43
ip dhcp excluded-address {{ device.services.dhcp_server.pools[0].network | regex_replace('/24', '') | regex_replace('0$', '1') }} {{ device.services.dhcp_server.pools[0].start }}
ip dhcp excluded-address {{ device.services.dhcp_server.pools[0].end }} {{ device.services.dhcp_server.pools[0].network | regex_replace('/24', '') | regex_replace('0$', '254') }}
!
{% for pool in device.services.dhcp_server.pools %}
ip dhcp pool {{ pool.name }}
 network {{ pool.network }}
 default-router {{ pool.gateway }}
{% for dns_server in pool.dns %}
 dns-server {{ dns_server }}
{% endfor %}
 option 43 ascii "{{ pool.option43 }}"
 lease 0 1 0
!
{% endfor %}
!
! Enable DHCP service
service dhcp
{% endif %}

! Static routing configuration
{% if device.routing is defined and device.routing.static_routes is defined %}
{% for route in device.routing.static_routes %}
ip route {{ route.destination }} {{ route.next_hop }}
{% endfor %}
{% endif %}

! Default route (if WAN interface uses DHCP)
ip route 0.0.0.0 0.0.0.0 {{ device.interfaces | selectattr('name', 'equalto', 'GigabitEthernet0/0/1') | first | attr('ip') | default('dhcp') }}
!
! NAT configuration for internet access
{% set wan_interface = device.interfaces | selectattr('ip', 'equalto', 'dhcp') | first %}
{% set lan_interface = device.interfaces | selectattr('ip', '!=', 'dhcp') | first %}
access-list 10 permit {{ lan_interface.ip | regex_replace('/24', '') | regex_replace('\.\d+$', '.0') }} 0.0.0.255
!
ip nat inside source list 10 interface {{ wan_interface.name }} overload
!
interface {{ lan_interface.name }}
 ip nat inside
!
interface {{ wan_interface.name }}
 ip nat outside
!

! SNMP Configuration
snmp-server community public RO
snmp-server community private RW
snmp-server location "{{ device.location }}"
snmp-server contact "Network Admin"
!

! NTP Configuration
ntp server 0.pool.ntp.org
ntp server 1.pool.ntp.org
clock timezone UTC 0 0
!

! Logging
logging buffered 16384 informational
logging console warnings
!

! Security settings
no ip source-route
no ip gratuitous-arps
ip tcp synwait-time 10
!

! AAA Configuration
aaa new-model
aaa authentication login default local
aaa authorization exec default local
!

! Line configuration
line con 0
 logging synchronous
 exec-timeout 30 0
line aux 0
line vty 0 4
 exec-timeout 30 0
 transport input ssh
!

! End of configuration
end